# radix-vulnerability-scanner-api
The for Radix Vulnerability Scanner API provides access to vulnerability scan results for applications hosted in Radix.

## Developing

You need Go installed. Make sure `GOPATH` and `GOROOT` are properly set up.

Also needed:

- [`go-swagger`](https://github.com/go-swagger/go-swagger) (on a Mac, you can install it with Homebrew: `brew install go-swagger`)
- [`statik`](https://github.com/rakyll/statik) (install with `go get github.com/rakyll/statik`)
- [`gomock`](https://github.com/golang/mock) (GO111MODULE=on go get github.com/golang/mock/mockgen@v1.4.4)

Clone the repo into your `GOPATH` and run `go mod download`.

### Generating mocks
We use gomock to generate mocks used in unit test.
You need to regenerate mocks if you make changes to any of the interface types used by the application

`make mocks`

### Running locally

Run once after cloning of the GitHub repository:

1. `go mod download`
2. `make swagger`
3. `make generate-radix-api-client`

The following env var is needed. Useful default values in brackets.

* `SQL_SERVER` - SQL server name
* `SQL_DATABASE` - SQL database name
* `SQL_USER` - SQL server user name
* `SQL_PASSWORD` - SQL server user password
* `RADIX_ENVIRONMENT` - Radix environment (ex. `qa`)
* `RADIX_CLUSTERNAME` - Radix cluster name (ex. `weekly-33`)
* `RADIX_DNS_ZONE` - Radix DNS zone (ex. `dev.radix.equinor.com`)
* `USE_LOCAL_RADIX_API`
  * `false`, `no` or not set` - connecting to in-cluster `radix-api`
  * `true` or `yes` - connecting to `radix-api`, running on `http://localhost:3002`
* `USE_PROFILER`
  * `false`, `no` or `not set` - do not use profiler
  * `true` or `yes` - use [pprof](https://golang.org/pkg/net/http/pprof/) profiler, running on `http://localhost:7070/debug/pprof`. Use web-UI to profile, when started service:
    ```
        go tool pprof -http=:6070 http://localhost:7070/debug/pprof/heap
    ```

#### Common errors running locally

- **Problem**: `panic: statik/fs: no zip data registered`

  **Solution**: `make swagger`

## Deployment

*WORK IN PROGRESS*

Radix Vulnerability Scanner API follows the [standard procedure](https://github.com/equinor/radix-private/blob/master/docs/how-we-work/development-practices.md#standard-radix-applications) defined in _how we work_. 

Radix Vulnerability Scanner API is installed as a Radix application in [script](https://github.com/equinor/radix-platform/blob/master/scripts/install_base_components.sh) when setting up a cluster. It will setup API environment with [aliases](https://github.com/equinor/radix-platform/blob/master/scripts/create_alias.sh), and a Webhook so that changes to this repository will be reflected in Radix platform. 

To install with `install_base_components.sh`, mentioned above - add RadixRegistration values and application secrets to Azure KeyVault:
1. If using a terminal - login to an Azure and switch to an Azure subscription:
    ```
    az login
    az account set -s "<SUBSCRIPTION-NAME>"
    ```
2. Create a file `radix-cost-allocation-api-radixregistration-values.yaml` with a content:
    ```
    repository: https://github.com/<GIT-USER>/<GIT-REPOSITORY>
    cloneURL: git@github.com:<GIT-USER>@<GIT-REPOSITORY>.git
    adGroups:
      - <AD-GROUP-IF-USED>
    deployKey: |
        -----BEGIN RSA PRIVATE KEY-----
        <YOUR-PRIVATE-KEY>
        -----END RSA PRIVATE KEY-----
    deployKeyPublic: ssh-rsa <YOUR-PUBLIC-KEY>
    sharedSecret: <SOME-RANDOM-TEXT>
    ```
3. Set the secret with following command or with Azure portal (`Key vault`/`Secrets`):
    ```
    az keyvault secret set  \
    -f radix-cost-allocation-api-radixregistration-values.yaml \
    -n radix-cost-allocation-api-radixregistration-values \
    --vault-name "<KEYVAULT>"
    ```
4. To check - run following command and read the created file `...-check.yaml` or with Azure portal (`Key vault`/`Secrets`):
    ```
    az keyvault secret download \
    -f radix-cost-allocation-api-radixregistration-values-check.yaml \
    -n radix-cost-allocation-api-radixregistration-values \
    --vault-name "<KEYVAULT>" 
    ```
5. Create a file `radix-cost-allocation-api-secrets.json` with content:
    ```
    {
      "db": {
        "server":"<SERVER>",
        "database":"<DATABASE>",
        "user":"<USER>",
        "password":"<PASSWORD>"
      },
      "subscriptionCost": {
        "value": "<COST-VALUE>",
        "currency": "<COST-CURRENCY>"
        "whiteList": "{"whiteList": ["APP1", "APP2"]}"
      },
      "auth": {
        "tokenIssuer": "https://sts.windows.net/<TENANT-ID>/",
        "reportReaders": "{"groups": ["<AD-GROUP>"]}"
      }
    }
    ```
6. Set the secret with following command or with Azure portal (`Key vault`/`Secrets`):
    ```
    az keyvault secret set \
    -f radix-cost-allocation-api-secrets.json \
    -n radix-cost-allocation-api-secrets \
    --vault-name "<KEYVAULT>"
    ```
7. To check - run following command and read the created file `...-check.json` or with Azure portal (`Key vault`/`Secrets`):
    ```
    az keyvault secret download \
    -f radix-cost-allocation-api-secrets-check.json \
    -n radix-cost-allocation-api-secrets \
    --vault-name "<KEYVAULT>" 
    ```