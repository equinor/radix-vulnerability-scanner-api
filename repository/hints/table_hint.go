package hints

import (
	"gorm.io/gorm"
	"gorm.io/gorm/clause"
	gormhints "gorm.io/hints"
)

type TableHint struct {
	Hints []string
}

func (tableHint TableHint) ModifyStatement(stmt *gorm.Statement) {
	for _, name := range []string{"FROM"} {
		clause := stmt.Clauses[name]

		if clause.AfterExpression == nil {
			clause.AfterExpression = tableHint
		} else {
			clause.AfterExpression = gormhints.Exprs{clause.AfterExpression, tableHint}
		}

		stmt.Clauses[name] = clause
	}
}

func (indexHint TableHint) Build(builder clause.Builder) {
	// Ignore errors here since Gorm provides builder and indexHint, but dont care about errors
	if len(indexHint.Hints) > 0 {
		_, _ = builder.WriteString("WITH")
		_ = builder.WriteByte('(')
		for idx, key := range indexHint.Hints {
			if idx > 0 {
				_ = builder.WriteByte(',')
			}
			_, _ = builder.WriteString(key)
		}
		_ = builder.WriteByte(')')
	}
}
