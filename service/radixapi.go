package service

import (
	"context"
	"strings"

	apiErrors "github.com/equinor/radix-vulnerability-scanner-api/api/errors"
	"github.com/equinor/radix-vulnerability-scanner-api/models"
	apiClient "github.com/equinor/radix-vulnerability-scanner-api/radix_api/generated_client/client"
	"github.com/equinor/radix-vulnerability-scanner-api/radix_api/generated_client/client/environment"
	serviceModels "github.com/equinor/radix-vulnerability-scanner-api/service/models"
	"github.com/equinor/radix-vulnerability-scanner-api/utils/slice"
	httptransport "github.com/go-openapi/runtime/client"
	"github.com/go-openapi/strfmt"
)

// RadixAPIService interface
type RadixAPIService interface {
	GetEnvironmentSummary(ctx context.Context, token, appName, envName string) (*serviceModels.EnvironmentSummary, error)
	GetEnvironmentSummaries(ctx context.Context, token, appName string) ([]*serviceModels.EnvironmentSummary, error)
}

// radixAPIClientStruct instance variables
type radixAPIService struct {
	client *apiClient.RadixAPI
	env    *models.Env
}

// NewRadixAPIClient constructor
func NewRadixAPIService(env *models.Env) RadixAPIService {
	transport := getRadixApiTransport(env)

	return &radixAPIService{
		client: apiClient.New(transport, strfmt.Default),
		env:    env,
	}
}

func (c *radixAPIService) GetEnvironmentSummary(ctx context.Context, token, appName, envName string) (*serviceModels.EnvironmentSummary, error) {
	summaries, err := c.GetEnvironmentSummaries(ctx, token, appName)
	if err != nil {
		return nil, err
	}

	env, found := slice.First(summaries, func(obj *serviceModels.EnvironmentSummary) bool { return strings.EqualFold(envName, obj.Name) })
	if !found {
		return nil, apiErrors.ErrNotFound
	}

	return env, nil
}

func (c *radixAPIService) GetEnvironmentSummaries(ctx context.Context, token, appName string) ([]*serviceModels.EnvironmentSummary, error) {
	resp, err := c.client.Environment.GetEnvironmentSummary(
		environment.NewGetEnvironmentSummaryParams().WithAppName(appName),
		httptransport.BearerToken(token),
	)

	if err != nil {
		switch err.(type) {
		case *environment.GetEnvironmentSummaryNotFound:
			return nil, apiErrors.WrapError(err, apiErrors.ErrNotFound)
		case *environment.GetEnvironmentSummaryUnauthorized:
			return nil, apiErrors.WrapError(err, apiErrors.ErrUnauthorized)
		default:
			return nil, err
		}
	}

	payloadLen := len(resp.Payload)
	envSummaries := make([]*serviceModels.EnvironmentSummary, payloadLen)
	for i := 0; i < payloadLen; i++ {
		envSummaries[i] = &serviceModels.EnvironmentSummary{}
		envSummaries[i].FromRadixApiModel(resp.Payload[i])
	}

	return envSummaries, nil
}

func getRadixApiTransport(env *models.Env) *httptransport.Runtime {
	return httptransport.New(env.GetRadixAPIURL(), "/api/v1", env.GetRadixAPISchemes())
}
