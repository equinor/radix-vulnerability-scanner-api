package vulnerability

import (
	"errors"
	"net/http"

	"github.com/equinor/radix-vulnerability-scanner-api/api"
	apiErrors "github.com/equinor/radix-vulnerability-scanner-api/api/errors"
	"github.com/equinor/radix-vulnerability-scanner-api/models"
	"github.com/equinor/radix-vulnerability-scanner-api/repository"
	"github.com/equinor/radix-vulnerability-scanner-api/service"
	"github.com/gin-gonic/gin"
)

const rootPath = ""

type controller struct {
	radixapi service.RadixAPIService
	repo     repository.Repository
}

// NewController Constructor
func NewController(radixapi service.RadixAPIService, repo repository.Repository) api.Controller {
	return &controller{
		radixapi: radixapi,
		repo:     repo,
	}
}

// GetRoutes List the supported routes of this controller
func (c *controller) GetRoutes() []api.Route {
	routes := []api.Route{
		{
			Path:    rootPath + "/applications/:appName/environments/:envName",
			Method:  "GET",
			Handler: c.GetEnvironmentVulnerabilitySummary,
		},
		{
			Path:    rootPath + "/applications/:appName/environments/:envName/components/:componentName",
			Method:  "GET",
			Handler: c.GetComponentVulnerabilities,
		},
		{
			Path:    rootPath + "/applications/:appName/environments/:envName/jobs/:jobName",
			Method:  "GET",
			Handler: c.GetJobVulnerabilities,
		},
	}

	return routes
}

// GetEnvironmentVulnerabilitySummary returns vulnerability counts aggregated by severity for components and jobs in an environment
func (ctrl *controller) GetEnvironmentVulnerabilitySummary(c *gin.Context) {
	// swagger:operation GET /applications/{appName}/environments/{envName} vulnerability getEnvironmentVulnerabilitySummary
	// ---
	// summary: Gets vulnerability summary for components in an environment
	// parameters:
	// - name: appName
	//   in: path
	//   description: Name of the application
	//   type: string
	//   required: true
	// - name: envName
	//   in: path
	//   description: Name of the environment
	//   type: string
	//   required: true
	// responses:
	//   "200":
	//     description: "Successful get vulnerability summary for application"
	//     schema:
	//        "$ref": "#/definitions/ApplicationCostSet"
	//   "401":
	//     description: "Unauthorized"
	//   "404":
	//     description: "Not found"

	user, ok := c.MustGet("user").(*models.User)
	if !ok {
		panic(errors.New("Invalid object type for user"))
	}

	h := NewVulnerabilityHandler(user, ctrl.radixapi, ctrl.repo)
	summary, err := h.GetEnvironmentVulnerabilitySummary(c.Request.Context(), c.Param("appName"), c.Param("envName"))
	if err != nil {
		apiErrors.HandleErrorJSON(c, err)
		return
	}

	c.JSON(http.StatusOK, summary)
}

// GetComponentVulnerabilities returns list of vulnerabilties for a component
func (ctrl *controller) GetComponentVulnerabilities(c *gin.Context) {
	// swagger:operation GET /applications/{appName}/environments/{envName}/components/{componentName} vulnerability getComponentVulnerabilities
	// ---
	// summary: Gets vulnerability summary for components in an environment
	// parameters:
	// - name: appName
	//   in: path
	//   description: Name of the application
	//   type: string
	//   required: true
	// - name: envName
	//   in: path
	//   description: Name of the environment
	//   type: string
	//   required: true
	// - name: componentName
	//   in: path
	//   description: Name of the component
	//   type: string
	//   required: true
	// responses:
	//   "200":
	//     description: "Successful get vulnerabilities for a component"
	//     schema:
	//        "$ref": "#/definitions/ApplicationCostSet"
	//   "401":
	//     description: "Unauthorized"
	//   "404":
	//     description: "Not found"

	user, ok := c.MustGet("user").(*models.User)
	if !ok {
		panic(errors.New("Invalid object type for user"))
	}

	h := NewVulnerabilityHandler(user, ctrl.radixapi, ctrl.repo)
	summary, err := h.GetComponentVulnerabilities(c.Request.Context(), c.Param("appName"), c.Param("envName"), c.Param("componentName"))
	if err != nil {
		apiErrors.HandleErrorJSON(c, err)
		return
	}

	c.JSON(http.StatusOK, summary)
}

// GetJobVulnerabilities returns list of vulnerabilties for a job
func (ctrl *controller) GetJobVulnerabilities(c *gin.Context) {
	// swagger:operation GET /applications/{appName}/environments/{envName}/jobs/{jobName} vulnerability getJobVulnerabilities
	// ---
	// summary: Gets vulnerability summary for job in an environment
	// parameters:
	// - name: appName
	//   in: path
	//   description: Name of the application
	//   type: string
	//   required: true
	// - name: envName
	//   in: path
	//   description: Name of the environment
	//   type: string
	//   required: true
	// - name: jobName
	//   in: path
	//   description: Name of the job
	//   type: string
	//   required: true
	// responses:
	//   "200":
	//     description: "Successful get vulnerabilities for a job"
	//     schema:
	//        "$ref": "#/definitions/ApplicationCostSet"
	//   "401":
	//     description: "Unauthorized"
	//   "404":
	//     description: "Not found"

	user, ok := c.MustGet("user").(*models.User)
	if !ok {
		panic(errors.New("Invalid object type for user"))
	}

	h := NewVulnerabilityHandler(user, ctrl.radixapi, ctrl.repo)
	summary, err := h.GetJobVulnerabilities(c.Request.Context(), c.Param("appName"), c.Param("envName"), c.Param("jobName"))
	if err != nil {
		apiErrors.HandleErrorJSON(c, err)
		return
	}

	c.JSON(http.StatusOK, summary)
}
