package models

import (
	"testing"
	"time"

	repositoryModels "github.com/equinor/radix-vulnerability-scanner-api/repository/models"
	"github.com/stretchr/testify/assert"
)

func Test_Vulnerability_FromDto(t *testing.T) {

	float32ptr := func(f float32) *float32 {
		return &f
	}

	pubTime := time.Now()
	dto := repositoryModels.VulnerabilityDto{
		ExternalId:      "snykid",
		PackageName:     "pkg",
		Version:         "ver",
		Title:           "title",
		Description:     "desc",
		Severity:        "sev",
		CVSS:            float32ptr(5.5),
		PublicationTime: pubTime,
		References:      []repositoryModels.VulnerabilityReferenceDto{{Url: "ref1"}, {Url: "ref2"}},
		Identifiers: []repositoryModels.VulnerabilityIdentifierDto{
			{IdentifierType: "CVE", Identifier: "cve1"}, {IdentifierType: "cve", Identifier: "cve2"},
			{IdentifierType: "CWE", Identifier: "cwe1"}, {IdentifierType: "cwe", Identifier: "cwe2"},
			{IdentifierType: "any", Identifier: "any"},
		},
	}

	sut := Vulnerability{}
	sut.FromDto(&dto)
	expected := Vulnerability{
		PackageName:   "pkg",
		Version:       "ver",
		Title:         "title",
		Description:   "desc",
		Severity:      "sev",
		PublishedDate: pubTime,
		CVSS:          float32ptr(5.5),
		CWE:           []string{"cwe1", "cwe2"},
		CVE:           []string{"cve1", "cve2"},
		References:    []string{"ref1", "ref2", "https://snyk.io/vuln/snykid"},
	}
	assert.Equal(t, expected, sut)
}
